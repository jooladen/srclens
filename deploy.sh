#!/bin/bash

# ============================================================
# srclens μλ™ λ°°ν¬ μ¤ν¬λ¦½νΈ
# ν™κ²½: Windows 10 + Git Bash
#
# μ‚¬μ©λ²•:
#   bash deploy.sh "μ»¤λ°‹ λ©”μ‹μ§€"
#   bash deploy.sh              (λ©”μ‹μ§€ μ—†μΌλ©΄ μλ™ μƒμ„±)
#
# μµμ΄ 1ν: vercel link λ¨Όμ € μ‹¤ν–‰ν•  κ²ƒ!
# ============================================================

# β”€β”€ μ„¤μ • (μ—¬κΈ°λ§ λ°”κΎΈλ©΄ λ¨) β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
NTFY_TOPIC="srclens-deploy"   # ntfy μ•±μ—μ„ κµ¬λ…ν• μ±„λ„ μ΄λ¦„
# β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€

# μ»¤λ°‹ λ©”μ‹μ§€ (μΈμ μ—†μΌλ©΄ λ‚ μ§+μ‹κ°„ μλ™ μƒμ„±)
if [ -z "$1" ]; then
  COMMIT_MSG="auto deploy $(date '+%Y-%m-%d %H:%M')"
else
  COMMIT_MSG="$1"
fi

# ntfy μ•λ¦Ό λ³΄λ‚΄λ” ν•¨μ
notify() {
  local title="$1"
  local msg="$2"
  local tags="${3:-bell}"
  curl -s \
    -H "Title: $title" \
    -H "Tags: $tags" \
    -H "Content-Type: text/plain" \
    -d "$msg" \
    "https://ntfy.sh/$NTFY_TOPIC" > /dev/null 2>&1
}

echo ""
echo "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"
echo "  srclens μλ™ λ°°ν¬ μ‹μ‘"
echo "  μ»¤λ°‹: $COMMIT_MSG"
echo "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"

# β”€β”€ STEP 1: λ³€κ²½μ‚¬ν•­ ν™•μΈ β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
echo ""
echo "[1/4] λ³€κ²½λ νμΌ ν™•μΈ μ¤‘..."
CHANGED=$(git status --porcelain)

if [ -z "$CHANGED" ]; then
  echo "  λ³€κ²½μ‚¬ν•­ μ—†μ. λ°°ν¬λ§ μ§„ν–‰ν•©λ‹λ‹¤."
  SKIP_GIT=true
else
  echo "  λ³€κ²½λ νμΌ:"
  git status --short | sed 's/^/    /'
  SKIP_GIT=false
fi

# β”€β”€ STEP 2: Git push β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
if [ "$SKIP_GIT" = false ]; then
  echo ""
  echo "[2/4] GitHubμ— μ¬λ¦¬λ” μ¤‘..."

  git add .
  git commit -m "$COMMIT_MSG"

  if git push; then
    echo "  β… GitHub push μ™„λ£!"
    notify "β… Push μ™„λ£!" "[$COMMIT_MSG] GitHubμ— μ¬λΌκ°”μ–΄μ”!" "white_check_mark"
  else
    echo "  β Push μ‹¤ν¨!"
    notify "β Push μ‹¤ν¨!" "μ—λ¬ λ°μƒ - ν„°λ―Έλ„ ν™•μΈν•μ„Έμ”" "x"
    exit 1
  fi
else
  echo ""
  echo "[2/4] λ³€κ²½μ‚¬ν•­ μ—†μ–΄μ„ git push κ±΄λ„λ€"
fi

# β”€β”€ STEP 3: Vercel λ°°ν¬ β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
echo ""
echo "[3/4] Vercel λ°°ν¬ μ¤‘... (1~2λ¶„ μ†μ”)"
echo "  (μ΄μ  μλ¦¬ λΉ„μ›λ„ λ©λ‹λ‹¤!)"
echo ""

# vercel link λλ”μ§€ ν™•μΈ
if [ ! -d ".vercel" ]; then
  echo "  β οΈ  Vercel ν”„λ΅μ νΈ μ—°κ²°μ΄ ν•„μ”ν•©λ‹λ‹¤!"
  echo "  μ•„λ λ…λ Ήμ–΄ μ‹¤ν–‰ ν›„ λ‹¤μ‹ μ‹λ„ν•μ„Έμ”:"
  echo ""
  echo "    vercel link"
  echo ""
  notify "β οΈ Vercel μ—°κ²° ν•„μ”!" "vercel link λ…λ Ήμ–΄λ¥Ό λ¨Όμ € μ‹¤ν–‰ν•μ„Έμ”" "warning"
  exit 1
fi

VERCEL_LOG=$(mktemp)
vercel --prod --yes > "$VERCEL_LOG" 2>&1
VERCEL_STATUS=$?

# β”€β”€ STEP 4: κ²°κ³Ό μ•λ¦Ό β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€
echo "[4/4] κ²°κ³Ό ν™•μΈ μ¤‘..."

if [ $VERCEL_STATUS -eq 0 ]; then
  # λ°°ν¬ URL μ¶”μ¶
  DEPLOY_URL=$(grep -E "https://.*\.vercel\.app" "$VERCEL_LOG" | grep -v "Inspect" | tail -1 | tr -d '[:space:]')

  echo ""
  echo "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"
  echo "  π‰ λ°°ν¬ μ™„λ£!"
  if [ -n "$DEPLOY_URL" ]; then
    echo "  π μ£Όμ†: $DEPLOY_URL"
    notify "π‰ λ°°ν¬ μ™„λ£!" "srclens λ°°ν¬λ¨! μ£Όμ†: $DEPLOY_URL" "rocket"
  else
    notify "π‰ λ°°ν¬ μ™„λ£!" "srclensκ°€ Vercelμ— λ°°ν¬λμ–΄μ”!" "rocket"
  fi
  echo "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"
else
  echo ""
  echo "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"
  echo "  β Vercel λ°°ν¬ μ‹¤ν¨!"
  echo ""
  echo "  μ—λ¬ λ‚΄μ©:"
  cat "$VERCEL_LOG" | sed 's/^/    /'
  echo "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"
  notify "β λ°°ν¬ μ‹¤ν¨!" "Vercel λ°°ν¬ μ—λ¬ - ν„°λ―Έλ„ ν™•μΈν•μ„Έμ”" "x"
fi

rm -f "$VERCEL_LOG"
echo ""
